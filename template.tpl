___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Matomo Analytics",
  "brand": {
    "id": "brand_dummy",
    "displayName": "data-marketing-school",
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHEAAABxCAYAAADifkzQAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAA7jSURBVHgB7Z17cFT1Fce/+16STUhipCGgbEAh6AwPecz4JGntYyqO0D+0aDsGZxT/6FQRraN/SNKZdsaORRzrjNSOpLUyFvtAxTLV0SwWbCugAXkrsCiQAAETCAkJSW7Pufdu2Cz7uPfu73d3Q+5n5pdlk73ZcL97zu+c83u5MExRFKWEHmqohalNoFai/zusvySc5LJ2vUX1583UDuvPoy6XqxnDEBeGCSRaDT3MoDYPmnglEA8L3Ky3jdQiJGw78py8FVG3tAXQRONHGaIZIULtLWrrSNAoHDLDFketido3Sv7xGbU6amE4DIVuSgm15Up+CpeK1dRmYKRDNyFM7XlleImXSJOi9dcjC0UTb7VyecGutgY5wNbARtGClUeoPYrcBSqyaaTWYGcQZJuI+qd0NZLnb5cj9SRkA2xAuoi69bF4CzDyiFKrlW2VbkhEt75DGJkCMmFqh+g+LIdEpFki/eHPQ+v7HDS4CrRQhlUKF1HREmF2nzVwSCQKTUihNVqhIuoCNmHkBC9WWUpCroQghPWJila9+AyOgEZ4XmQ/KURE+oPuh2aBl2vuJ4N6UUJm7U51ARvhYJWV5FqXIguyskRHQCE8mq1FWrbEuD7QQQyWKzyWRNSjUBbQ6QPFYilqNS2ik0ZIh/PIdWYusCIiW6AzGCoPntMz00xlx1Rgo3fAjoBy4S6qSR84MIRhEemXchG7Hg52EKZmOGI15E6dfjBnGOofjYrIBe06ONgN949Vmea+ZnSnJGAdHAFzBfeLGd1qWkvUO9ecFLWPnejE2XO9ONvVqz6fUlWGogI/7KLn7Cn4uk5BOX9Wfd5XOgGB4nLkCJ4dEEn1Qy/Sw5OawrCJrTtb8U7TAUS2fKUKmEjlmBBmXV+Be++Yqooqmv7D29C3byO6d74HLwl4IeHnfcEieCbPg7ea2uQa2AgPsM9M9cOUlqgHM4dgAyze8pc2o4Wszyg1c6/GEw/MwdgrQ8gWFq/3o1fUR6O4R4+Ff95D8E6bD5tIWc1JJ6Itwcxzr27Bmnd3wypL7p6BJfdMh1W6Nv0JA5EXYRXf3EUIfO8x2EDKICepiHZYIfd1Dz7zL+w/dBrZYlXIrg2/wcC2N5Et7orJGPXTl+EKFEEyPJ+1PvGbqaJTqbOz1Dd4cbMQAZlVa5ux6i/bTV3D7lOEgMxA6370vP1L2MAjySo5l4ioW2EdJLJq7XZEPvkKImEht+5qNfTavh3rScTfQyR9+yK48MkbkAwLWJf4zWSWWAeJHDvZSVYjdLLXIPW/2zyYkqSjd6NYAQd/L30wlI4WSOauxG8kE/F+SITdqCw4t8zkVtkKByTdaM4p9/+1HpKpSVy4M0REvcgdhiTebvoS2wy6PKusWb8bTWlctSwrjFF65FN88P7rkMyQGfWJlijNClU3utZc8GEVdqstJy/NOXtOHpZmhTEKPMDHG1bhRNsxSOT++ABnUETl4hp5KbCbM5PMZwNXe55J4rY9p22pXWCq6xxeapQa4A/RKt4SpQnIbvQdanbCbptdazwDx/fDDsrorn6+dyve2yQ1Wk0q4l2QgJ1uNJHnVm/BvujFXNSGyFGlgO5q/wUF7/77D+jukeZ95sVcaryINZCAnW40GcuebTKUdohE4UZfzlG0urbp15AEC6hOlVFF1ENW4dMPtVEJe91oIvFph4uK1nbQ1a+oBU0XtX1HN2PfsU2QhOpSY5YoZfITj0zkA9w3cjXHXVIJO4h2K/D6XHB73XBRtLphx3Po6ZPijdSCcUzEeRAM94O5dKOJcNrRPf5G2MGuzgH4Am74/C54SMhe5Rz+d/g1SIAT/xIpliiztGYVdquPrdwKz4RZkMmJHgW7uwfgH+WGP+iGl4R0e1xoblmHox07IIGwW49wwhAIDzHlI5x2rP16ImSy69wAAiRggEJUX5Askd2qh7tIFz488Ftyq+cgmBq2RKFWmG9uNJFX916F4y45fSNb4RstfQiGPAgUesgSPWSJbtUSOcg503MCW47+GYIJCxUxH91oIlzNeWrPbZDBmiN9OON1YVSxF6NC5E7JGlVL5LusR6s72K2eEepWVRHDEITMEQqRfNldjheP3AqRvHa0FB919KNgtBeF1NgaObjxkKguN1vixUkUHx5YIdKtTmcRJ0AAdoxQiOTNk9OxumUuRNDYMg1rj3QiVOZF8RUkYqlHEzHIIpIFJgwznO05LtKtqpaYdZKfy9JaNqxunYunD/4Qrb3W5sZ09gdUi379aw+5z3MIlfpIQHKlRV6KTj16UKNZoSthNpNItyrEnea6tJYNmzom4udfLMSGU1NNXcevf2DvPfjbiTAKXB+jsMSLghKP2h8GCim1CFBk6tH6QVeKOYWi3KqLUgwenwnDIuxGOZFWoT7AVR2Ce3wQKPfDVazNTVZ6BoA2ql+e7MXAwS4oR88jH6nwn8HM0DH8oGwPri1oQ8jTM/gztrovuspV0TecrlafM6Hul1FyRTfKxvlxxXg/Ro/xo6CYXOmo+P4w9XtOG7sAt0xYgmxgERVYhN0o54QtA73w3FYG17igoeuUM30Y+KQdyp7hab0x/D2bMTr4X5RV+lURSyt81C/6NEvk1MINVcRM3HXdsxhXPA1WyWr3jDXv7MHxSvqDF1UaFpBhC/XcXg7PjyqA4kwrCfITt9KBUdDcKAc0/KgFMy7dAoG0JhhHtm7Vsoj7Dp3GG5S8um+1viaChfcsHJ5CBrr/SamERxUwxMEMuVAutXl87pTBTCo4Wt3R+g9YxbKIT2z7HO6p2a+DUK1ymAnpu7ATBYEjqoBF1ApIzGABBzPujMFMKrYceR1tXQdhBUsivhI9jFaBq7xUIe8YowZG+Y7qRhVyo1f4UFzuU4XkiNRf4FGL3S6PBQV1PvhyBazAd63dzAUt58+TiFGIxkXR7Oibcrb+zzCBC5tRWNRJFujT3GiRRy14q+OHbnNuNJFTXQfIIs0XAUyLyFYoC/eMYkyZkr9C+vp2otC3WxWPW4FeXuOc0K0HM1YFjLGjdZ3pIMeUiGyF61vlldbO9vWhesEEFBXatyLYKK6BDgT7P6aEPhaNUj9YpJfWfHo0KmD7WBZwX9v7pq7ht44affHGtjbIpsXfj/qf3Yx8w9+7FQWhTtUCubTGCb0oN5rIwdP/MfV6FrHD6Is3tp2CbD5tb8fsGypx73xzZTCZeJQTGOX+VE0pOB8sLPbobtQtzI3Gc4xqqiZcajuLaHgA8Ay5OztoJbfNC0fHjsk+hRFBsPvvahqhCkiPgUtGKAQqqNPbb7ia1WzKnX7RaU+Z7BiJyP3iil/UItfcd8dEVIVHayMUJZobVXNCf8yNirXCGGeoAGCQDlOWaDe8Q8bji+cgV/BuHcseuBVPPf4rygm9al4YpJzQpw8zQZIVmiTi1nfzMxShjg0ar49mQ8h7sXpz7/zr1G1PcsErDd9XH6dOmoUb53xbjUb9koKZLGiOlUgMWaNdIlYmvE8DRat2px1L7p4+pE9edPvTKB5dBJ/AnDAd5QWTjL50UERDw/KTQ4WQDX9QEj8s7NbsTDv4/ZbcM3T+WNAfQu20OqE5YSrKCyci4DV0r5t5S5SYiBl38mPmlcuvpswqST5bpHbu1balHak+MDPHLcRVpdOlu1EzVshfTLlTvsHXhuSG/Q+GU8/bsiPtuLN2Eman6YNvv3YZgj65HmnO+PuMvnQjf9Ecg7ZLUcTIVQ+FhUyOS8r8ioq0/S73iw0S3Sq70YfvTj8NtyjwLcwe9xPIovrK76rvYZAIf4kf+3nLyFXsUm8oEb4KDkUUkT5o4APCViIr7UgMZlIxfewCVGYxnSIVLJ4JK4zE9gmPF9FQv8gsr54iPFJlAY3+ThlpBwt4Z+01hl//nUmPmbEYQ9w8YYmZ3/nH2D8GRdRVjRi4WL3ZL8+YLkxIFvDH48ebumbFk7WYHBazXSb3g4nRaCb4Zi+47llhQt4SXoKJZaaW3kVi/xgSYymK8ii0vTUNwUNTDzdvVx+twC506TWT1L7QCryugrcDW7N+D6zCFmhWwCF/A5XH1u1+Un20AqcStROXmRaQjG6wJpkoInd2PA/VVKfHI/3rW4+bEnNWyWg8U10txJp57qvZ1Vizr/8WHiLxZgtyyzwib3ZAt4qEu8WcC42xmERsjD25JNshIfmHpjclYgG30TDSuzRovK09+ejW2GBADYy4zZIQHLGY66lt3ZXcKji6ZfEWUZ86W0Ipj62Rp+bvPfk+DSd9nvQ1RYExqCq9SRXQ4lzTKAlYFf+NZCLWQDs+wTI8Qr8/YcSjMkklRiY8pZJ3zeAJzpVXhrRm49AWW2Rb14HB5+w2i/wVRisx6WgkERfHfyPVprUsYg0c8pGqxCOIUs0RbIBDPtKY7AypdHuAO9aYf1QlEzHdbF3HGvOLxlQnuWU63MSxxvwgCu2Ak2iyH2aaN89RkKnJxQ5SeCHdeYppRdQvfAEOuSSa6YjajEObuTwvykGlKtOpphmXIeljjYvhkAsajBxLa3iSAVkkm/QjcLCLS8prqTA1U8SJVm3D1OHQZld1sluNwkE2S40KyJgSUf/FTv8ol4b4YSYjmF5frZ+ouRQOMliX7FS2TFhaJK/nLU5ZTiw8bdSSl8tqCiwFOvWw4Zi+EUAUacpqmch6HrPVmQAOg0SRhYBM1nuO0JvXwXGtVokiSwEZIRvH6J2xI6Q5uA/MWkBG2O4/jpCm4InaQgRkhK/t0c9g5JPBxU9nuzxosJJGpEPKAi39XGIu0YXhEINLaUvNJvJGkLKZmu4mZsIZi4zB/d9MGQIy0nbE4yEsarwsYKTXW3lUfqao/i8ZtmwboLvXeoysfJKtb6leppSKrXs/kJi8coV3Zw3j8oX7voZMUypEYusGo/Qfa9YHOi9HF6uKB206hW0C5hyyzDo+DUAZ3nxDbaWidRkjF2V4isni1StxR6XnitzvhxSHoq3IqoN2SHW+Fgsi0PY3aNQnkeWcvBIxhv7p5soPi1mD3AsaQZ4JF09eipiIbqEsKp+hWwP5RKEJx/vErMtH4eIZFiImoovK6UoYmrBhWEtbotCiSs7ptuvPI/kuWiL/B2t2Wsn+RGQWAAAAAElFTkSuQmCC"
  },
  "description": "",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "SELECT",
    "name": "clientType",
    "displayName": "Client Type",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": "matomoClient",
        "displayValue": "Matomo Client"
      },
      {
        "value": "ga4Client",
        "displayValue": "GA4 Client"
      }
    ],
    "simpleValueType": true,
    "defaultValue": "ga4Client"
  },
  {
    "type": "TEXT",
    "name": "instanceUrl",
    "displayName": "Matomo Instance URL",
    "simpleValueType": true,
    "valueHint": "https://website.matomo.cloud",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "REGEX",
        "args": [
          "^https://.*"
        ]
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "tokenAuth",
    "displayName": "Auth Token",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "valueHint": "18e935w0576932fer43c7986ce39cbbf"
  },
  {
    "type": "TEXT",
    "name": "idSiteMatomoClient",
    "displayName": "Site ID",
    "simpleValueType": true,
    "valueHint": "1",
    "enablingConditions": [
      {
        "paramName": "clientType",
        "paramValue": "matomoClient",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "idSiteGa4Client",
    "displayName": "Site ID",
    "simpleValueType": true,
    "valueHint": "1",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "POSITIVE_NUMBER"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "clientType",
        "paramValue": "ga4Client",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "SELECT",
    "name": "eventType",
    "displayName": "Event Type",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": "pageview",
        "displayValue": "Page View"
      },
      {
        "value": "actions",
        "displayValue": "Actions"
      },
      {
        "value": "ecommerceTracking",
        "displayValue": "E-commerce Tracking"
      },
      {
        "value": "contentTracking",
        "displayValue": "Content Tracking"
      },
      {
        "value": "heartbeat",
        "displayValue": "Heartbeat"
      }
    ],
    "simpleValueType": true,
    "defaultValue": "pageview",
    "enablingConditions": [
      {
        "paramName": "clientType",
        "paramValue": "ga4Client",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "actions",
    "displayName": "Actions",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SELECT",
        "name": "action",
        "displayName": "Action type",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "event",
            "displayValue": "Event"
          },
          {
            "value": "goal",
            "displayValue": "Goal"
          },
          {
            "value": "link",
            "displayValue": "Link"
          },
          {
            "value": "siteSearch",
            "displayValue": "Site Search"
          }
        ],
        "simpleValueType": true,
        "subParams": []
      },
      {
        "type": "TEXT",
        "name": "linkUrl",
        "displayName": "Link URL",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "action",
            "paramValue": "link",
            "type": "EQUALS"
          }
        ],
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "valueHint": "https://example.com"
      },
      {
        "type": "SELECT",
        "name": "linkType",
        "displayName": "Link Type",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "link",
            "displayValue": "Link"
          },
          {
            "value": "download",
            "displayValue": "Download"
          }
        ],
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "action",
            "paramValue": "link",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "goalId",
        "displayName": "Goal ID",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "action",
            "paramValue": "goal",
            "type": "EQUALS"
          }
        ],
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          },
          {
            "type": "POSITIVE_NUMBER"
          }
        ],
        "valueHint": "1"
      },
      {
        "type": "TEXT",
        "name": "goalRevenue",
        "displayName": "Goal Revenue",
        "simpleValueType": true,
        "valueHint": "9.99",
        "enablingConditions": [
          {
            "paramName": "action",
            "paramValue": "goal",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "eventCategory",
        "displayName": "Event Category",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "action",
            "paramValue": "event",
            "type": "EQUALS"
          }
        ],
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "eventAction",
        "displayName": "Event Action",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "action",
            "paramValue": "event",
            "type": "EQUALS"
          }
        ],
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "eventName",
        "displayName": "Event Name",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "action",
            "paramValue": "event",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "eventValue",
        "displayName": "Event Value",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "action",
            "paramValue": "event",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "searchKeyword",
        "displayName": "Keyword",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "action",
            "paramValue": "siteSearch",
            "type": "EQUALS"
          }
        ],
        "valueValidators": [],
        "valueHint": "red shoes",
        "help": "Default: eventData.search_term"
      },
      {
        "type": "TEXT",
        "name": "searchCategory",
        "displayName": "Category",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "action",
            "paramValue": "siteSearch",
            "type": "EQUALS"
          }
        ],
        "valueHint": "shoes"
      },
      {
        "type": "TEXT",
        "name": "searchResults",
        "displayName": "Number of results",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "action",
            "paramValue": "siteSearch",
            "type": "EQUALS"
          }
        ],
        "valueHint": "6"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "actions",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "ecommerce",
    "displayName": "E-commerce Tracking",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SELECT",
        "name": "ecommerceEventType",
        "displayName": "E-commerce event type",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "categoryView",
            "displayValue": "Category View"
          },
          {
            "value": "productView",
            "displayValue": "Product View"
          },
          {
            "value": "cartUpdate",
            "displayValue": "Cart Update"
          },
          {
            "value": "ecommerceOrder",
            "displayValue": "Ecommerce Order"
          }
        ],
        "simpleValueType": true,
        "enablingConditions": []
      },
      {
        "type": "TEXT",
        "name": "items",
        "displayName": "Items",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "ecommerceEventType",
            "paramValue": "cartUpdate",
            "type": "EQUALS"
          },
          {
            "paramName": "ecommerceEventType",
            "paramValue": "ecommerceOrder",
            "type": "EQUALS"
          }
        ],
        "help": "Default: eventData.items"
      },
      {
        "type": "TEXT",
        "name": "value",
        "displayName": "Value",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "ecommerceEventType",
            "paramValue": "cartUpdate",
            "type": "EQUALS"
          },
          {
            "paramName": "ecommerceEventType",
            "paramValue": "ecommerceOrder",
            "type": "EQUALS"
          }
        ],
        "help": "Default: eventData.value"
      },
      {
        "type": "TEXT",
        "name": "category",
        "displayName": "Category",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "ecommerceEventType",
            "paramValue": "categoryView",
            "type": "EQUALS"
          },
          {
            "paramName": "ecommerceEventType",
            "paramValue": "productView",
            "type": "EQUALS"
          }
        ],
        "help": "Default: eventData.items[0].item_category"
      },
      {
        "type": "TEXT",
        "name": "product_sku",
        "displayName": "Product SKU",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "ecommerceEventType",
            "paramValue": "productView",
            "type": "EQUALS"
          }
        ],
        "help": "Default: eventData.items[0].item_id"
      },
      {
        "type": "TEXT",
        "name": "product_name",
        "displayName": "Product Name",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "ecommerceEventType",
            "paramValue": "productView",
            "type": "EQUALS"
          }
        ],
        "help": "Default: eventData.items[0].item_name"
      },
      {
        "type": "TEXT",
        "name": "product_price",
        "displayName": "Product Price",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "ecommerceEventType",
            "paramValue": "productView",
            "type": "EQUALS"
          }
        ],
        "help": "Default: eventData.items[0].price"
      },
      {
        "type": "TEXT",
        "name": "order_id",
        "displayName": "Order ID",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "ecommerceEventType",
            "paramValue": "ecommerceOrder",
            "type": "EQUALS"
          }
        ],
        "help": "Default: eventData.transaction_id"
      },
      {
        "type": "TEXT",
        "name": "sub_total",
        "displayName": "Subtotal",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "ecommerceEventType",
            "paramValue": "ecommerceOrder",
            "type": "EQUALS"
          }
        ],
        "help": "Default: null"
      },
      {
        "type": "TEXT",
        "name": "tax",
        "displayName": "Tax",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "ecommerceEventType",
            "paramValue": "ecommerceOrder",
            "type": "EQUALS"
          }
        ],
        "help": "Default: eventData.tax"
      },
      {
        "type": "TEXT",
        "name": "shipping",
        "displayName": "Shipping",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "ecommerceEventType",
            "paramValue": "ecommerceOrder",
            "type": "EQUALS"
          }
        ],
        "help": "Default: eventData.shipping"
      },
      {
        "type": "TEXT",
        "name": "discount",
        "displayName": "Discount",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "ecommerceEventType",
            "paramValue": "ecommerceOrder",
            "type": "EQUALS"
          }
        ],
        "help": "Default: eventData.discount"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "ecommerceTracking",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "contentTracking",
    "displayName": "Content Tracking",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SELECT",
        "name": "contentTrackingType",
        "displayName": "Content Tracking Type",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "contentImpression",
            "displayValue": "Content Impression"
          },
          {
            "value": "contentInteraction",
            "displayValue": "Content Interaction"
          }
        ],
        "simpleValueType": true,
        "enablingConditions": [],
        "defaultValue": "contentImpression"
      },
      {
        "type": "TEXT",
        "name": "contentInteraction",
        "displayName": "Content Interaction",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "contentTrackingType",
            "paramValue": "contentInteraction",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "contentName",
        "displayName": "Content Name",
        "simpleValueType": true,
        "enablingConditions": []
      },
      {
        "type": "TEXT",
        "name": "contentPiece",
        "displayName": "Content Piece",
        "simpleValueType": true,
        "enablingConditions": []
      },
      {
        "type": "TEXT",
        "name": "contentTarget",
        "displayName": "Content Target",
        "simpleValueType": true,
        "enablingConditions": []
      }
    ],
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "contentTracking",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "customDimensionsGA4Client",
    "displayName": "Custom Dimensions",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "cdTable",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Custom Dimension ID",
            "name": "customDimensionId",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              },
              {
                "type": "POSITIVE_NUMBER"
              }
            ],
            "isUnique": true
          },
          {
            "defaultValue": "",
            "displayName": "Custom Dimension Value",
            "name": "customDimensionValue",
            "type": "TEXT"
          }
        ],
        "newRowButtonText": "New custom dimension"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "clientType",
        "paramValue": "ga4Client",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "parameters",
    "displayName": "Parameters",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "parametersToExclude",
        "displayName": "Parameters to Exclude",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Name",
            "name": "parameterName",
            "type": "TEXT"
          }
        ],
        "help": "Parameters listed here will not be sent to Matomo."
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "parametersToAddEdit",
        "displayName": "Parameters to Add / Edit",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Name",
            "name": "parameterName",
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "parameterValue",
            "type": "TEXT"
          }
        ],
        "help": "Parameters listed here will be added to the event sent to Matomo. If the parameter is already included, then the value will be replaced with the specified value."
      }
    ],
    "enablingConditions": [
      {
        "paramName": "clientType",
        "paramValue": "matomoClient",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "customDimensionsMatomoClient",
    "displayName": "Custom Dimensions",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "customDimensionsToExclude",
        "displayName": "Custom Dimensions to Exclude",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "ID",
            "name": "customDimensionId",
            "type": "TEXT"
          }
        ],
        "help": "Parameters listed here will not be sent to Matomo."
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "customDimensionsToAddEdit",
        "displayName": "Custom Dimensions to Add / Edit",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "ID",
            "name": "customDimensionId",
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "customDimensionValue",
            "type": "TEXT"
          }
        ],
        "help": "Parameters listed here will be added to the event sent to Matomo. If the parameter is already included, then the value will be replaced with the specified value."
      }
    ],
    "enablingConditions": [
      {
        "paramName": "clientType",
        "paramValue": "matomoClient",
        "type": "EQUALS"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const log = require("logToConsole");
const Object = require("Object");
const JSON = require("JSON");
const getType = require("getType");
const encodeUriComponent = require("encodeUriComponent");
const getAllEventData = require("getAllEventData");
const sendHttpRequest = require("sendHttpRequest");
const generateRandom = require("generateRandom");
const sha256Sync = require("sha256Sync");
const eventData = getAllEventData();

let instanceUrl = data.instanceUrl + '/matomo.php';

sendHttpRequest(data.clientType == "matomoClient" ? instanceUrl + getMatomoQueryParamsFromMtm() : instanceUrl + getMatomoQueryParamsFromGa(), {
    method: "GET"
  })
  .then((response) => {
      if (response.statusCode >= 200 && response.statusCode < 300) {
        data.gtmOnSuccess();
      } else {
        data.gtmOnFailure();
      }
  })
  .catch(() => {
     data.gtmOnFailure();
  });

function getMatomoQueryParamsFromMtm(){
  var matomoQueryParams = eventData;
  matomoQueryParams.token_auth = data.tokenAuth;
  if(data.idSiteMatomoClient) {
    matomoQueryParams.idsite = data.idSiteMatomoClient || eventData.idsite;
  }
  
  if(data.parametersToExclude) {
    data.parametersToExclude.forEach(parameterToExclude => {
      if(matomoQueryParams[parameterToExclude.parameterName]) {
        matomoQueryParams[parameterToExclude.parameterName] = null;
      }
    });
  }
  
  if(data.parametersToAddEdit) {
    data.parametersToAddEdit.forEach(parameterToAddEdit => {
      matomoQueryParams[parameterToAddEdit.parameterName] = parameterToAddEdit.parameterValue;
    });
  }
  
  if(data.customDimensionsToExclude) {
    data.customDimensionsToExclude.forEach(customDimensionToExclude => {
      if(matomoQueryParams["dimension" + customDimensionToExclude.customDimensionId]) {
        matomoQueryParams["dimension" + customDimensionToExclude.customDimensionId] = null;
      }
    });
  }
  
  if(data.customDimensionsToAddEdit) {
    data.customDimensionsToAddEdit.forEach(customDimensionToAddEdit => {
      matomoQueryParams["dimension" + customDimensionToAddEdit.customDimensionId] = customDimensionToAddEdit.customDimensionValue;
    });
  }
  
  
  matomoQueryParams.event_name = null;
  return serialize(matomoQueryParams);
}

function getMatomoQueryParamsFromGa() {
  let matomoQueryParams = {
		//Required parameters
		idsite: data.idSiteGa4Client,
		rec: eventData.rec || 1,

		//Recommended parameters
        action_name: eventData.page_title || eventData.action_name,
		url: eventData.page_location || eventData.url,
		_id: eventData._id || generateVisitorId(),
		rand: eventData.rand || generateRandom(0, 100000000),
		apiv: 1,

		//Optional user info
		urlref: eventData.page_referrer || eventData.urlref,
		res: eventData.screen_resolution || eventData.res,
		h: eventData.h || null,
		m: eventData.m || null,
		s: eventData.s || null,
		cookie: 1,
		ua: eventData.ua || eventData.user_agent,
		uadata: eventData.uadata || eventData.client_hints,
		lang: eventData.lang || eventData.language,
		uid: eventData.uid || eventData.user_id,
		cid: eventData.cid || generateVisitorId(),
		new_visit: eventData.new_visit || 0,
    
        //Ecommerce
        idgoal: eventData.idgoal,
        ec_items: eventData.ec_items,
        revenue: eventData.revenue,
        ec_id: eventData.ec_id,
        ec_st: eventData.ec_st,
        ec_tx: eventData.ec_tx,
        ec_sh: eventData.ec_sh,
        ec_dt: eventData.ec_dt,

		//Optional Acquisition Channel Attribution
		_rcn: eventData._rcn,
		_rck: eventData._rck,

		//Optional action info
		cvar: eventData.cvar,
		link: eventData.link,
		download: eventData.download,
		pv_id: eventData.pv_id,
		cs: eventData.cs,
        search: eventData.search,
	    search_cat: eventData.search_cat,
	    search_count: eventData.search_count,

		//Optional page performance
		pf_net: eventData.pf_net,
		pf_srv: eventData.pf_srv,
		pf_tfr: eventData.pf_tfr,
		pf_dm1: eventData.pf_dm1,
		pf_dm2: eventData.pf_dm2,
		pf_onl: eventData.pf_onl,


		//Other parameters
		token_auth: data.tokenAuth,
		cip: eventData.cip || eventData.ip_override,
		cdt: null,
		country: null,
		region: null,
		city: null,
		lat: null,
		long: null,
        send_image: eventData.send_image || 0,
    
        // plugins
        pdf: eventData.pdf,
        qt: eventData.qt,
        realp: eventData.realp,
        wma: eventData.wma,
        fla: eventData.fla,
        java: eventData.java,
        ag: eventData.ag,

		//Media Analytics parameters
		ma_id: eventData.ma_id, 
		ma_ti: eventData.ma_ti,
		ma_re: eventData.ma_re,
		ma_mt: eventData.ma_mt,
		ma_pn: eventData.ma_pn,
		ma_st: eventData.ma_st,
		ma_le: eventData.ma_le,
		ma_ps: eventData.ma_ps,
		ma_ttp: eventData.ma_ttp,
		ma_w: eventData.ma_w,
		ma_h: eventData.ma_h,
		ma_fs: eventData.ma_fs,
		ma_se: eventData.ma_se,

	};
  
   if(data.eventType == "actions") {
    
    if(data.action == "event"){
      matomoQueryParams.e_c = data.eventCategory;
	  matomoQueryParams.e_a = data.eventAction;
	  matomoQueryParams.e_n = data.eventName;
	  matomoQueryParams.e_v = data.eventValue;
    } else if(data.action == "goal") {
      matomoQueryParams.idgoal = data.goalId;
      matomoQueryParams.revenue = data.goalRevenue;
    } else if(data.action == "link") {
      matomoQueryParams[data.linkType] = data.linkUrl;
    } else if(data.action == "siteSearch") {
      matomoQueryParams.action_name = null;
      matomoQueryParams.search = data.searchKeyword || eventData.search_term;
	  matomoQueryParams.search_cat = data.searchCategory;
	  matomoQueryParams.search_count = data.searchResults;
    }
  }
  
  if(data.eventType == "ecommerceTracking") {
    
    if(data.ecommerceEventType == "productView") {
      matomoQueryParams._pkc = data.category || eventData.items[0].item_category;
      matomoQueryParams._pkp = data.value || eventData.items[0].price;
      matomoQueryParams._pks = data.product_sku || eventData.items[0].item_id;
      matomoQueryParams._pkn = data.product_name || eventData.items[0].item_name;
       
    } else if(data.ecommerceEventType == "categoryView") {
      
      matomoQueryParams._pkc = data.category || eventData.items[0].item_category;

    } else if(data.ecommerceEventType == "cartUpdate" && eventData.items) {
      
      matomoQueryParams.idgoal = 0;
      matomoQueryParams.ec_items = getEcommerceItems();
	  matomoQueryParams.revenue = data.value || eventData.value;
    
    } else if(data.ecommerceEventType == "ecommerceOrder") {
      
      matomoQueryParams.idgoal = 0;
      matomoQueryParams.ec_id = data.order_id || eventData.transaction_id;
      matomoQueryParams.ec_items = getEcommerceItems();
	  matomoQueryParams.revenue = data.value || eventData.value;
      matomoQueryParams.ec_st = data.subtotal;
	  matomoQueryParams.ec_tx = data.tax || eventData.tax;
	  matomoQueryParams.ec_sh = data.shipping || eventData.shipping;
	  matomoQueryParams.ec_dt = data.discount || eventData.discount;
      
    }
  }
  
  if(data.eventType == "contentTracking") {
   
		matomoQueryParams.c_n = data.contentName;
		matomoQueryParams.c_p = data.contentPiece;
		matomoQueryParams.c_t = data.contentTarget;
    
    if(data.contentTrackingType == "contentInteraction") {
		matomoQueryParams.c_i = data.contentInteraction;
    
    }
  
  }
  
  if(getType(data.cdTable) != 'undefined') {
    data.cdTable.forEach((cd) => {
      matomoQueryParams['dimension'+cd.customDimensionId] = cd.customDimensionValue;
    });  
  
  }
  
  if(data.eventType == "heartbeat") {
    matomoQueryParams.ping = 1;
    matomoQueryParams.action_name = null;
  }

  return serialize(matomoQueryParams);
}

function generateVisitorId() {
    let visitorId;
    if(eventData.client_id) {
      visitorId = sha256Sync(eventData.client_id.split('.').join(''))
        .split(']')
        .join('')
        .split('[')
        .join('')
        .slice(0, 16);
    }
    return visitorId;
}

function getEcommerceItems() {
  
	  let items = null;
          
      if(eventData.items) {
        items = JSON.stringify(
          eventData.items.map((item) => [
            item.item_id,
            item.item_name,
            item.item_category,
            item.price,
            item.quantity,
          ])
        );
      }
      return items;
}


function serialize( obj ) {
    let str = '?' + Object.keys(obj)
    .reduce(function(a, k){
        if(getType(obj[k]) != 'null' && getType(obj[k]) != 'undefined') {
          a.push(k + '=' + encodeUriComponent(obj[k]));          
        }
        return a;
    }, []).join('&');
    return str;
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 20/05/2024, 16:34:06


